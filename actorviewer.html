<script>
    // Date formatting
    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
    };

    // View management
    const toggleViews = (showForm, isUpdate = false) => {
        $('#showAddButton').toggle(!showForm);
        $('#actorTable').toggle(!showForm);
        $('#addUpdateForm').toggle(showForm);

        $('#addLabel').toggle(!isUpdate);
        $('#updateLabel').toggle(isUpdate);
        $('#doAddButton').toggle(!isUpdate);
        $('#doUpdateButton').toggle(isUpdate);
    };

    const showAdd = () => {
        clearForm();
        toggleViews(true);
    };

    const showViewAll = () => toggleViews(false);

    const showUpdate = (button) => {
        const row = $(button).closest('tr');
        const actor = {
            id: row.data('id'),
            name: row.find('.actor-name').text(),
            gender: row.find('.actor-gender').text(),
            dob: row.find('.actor-dob').data('date'),
            country: row.find('.actor-country').text()
        };

        populateForm(actor);
        toggleViews(true, true);
    };

    const cancelForm = () => {
        clearForm();
        showViewAll();
    };

    // Form handling
    const clearForm = () => {
        $('#addUpdateForm')[0].reset();
        $('input[name="id"]').val('');
    };

    const populateForm = (actor) => {
        $('input[name="id"]').val(actor.id);
        $('input[name="name"]').val(actor.name);
        $('select[name="gender"]').val(actor.gender);
        $('input[name="dob"]').val(actor.dob);
        $('select[name="country"]').val(actor.country);
    };

    const getFormData = () => ({
        id: $('input[name="id"]').val(),
        name: $('input[name="name"]').val(),
        gender: $('select[name="gender"]').val(),
        dob: $('input[name="dob"]').val(),
        country: $('select[name="country"]').val()
    });

    // CRUD Operations
    const loadActors = () => {
        $.ajax({
            url: '/actors',
            method: 'GET',
            success: (actors) => {
                const tbody = $('#actorTable tbody').empty();
                actors.forEach(actor => {
                    tbody.append(`
                        <tr data-id="${actor.id}">
                            <td>${actor.id}</td>
                            <td class="actor-name">${actor.name}</td>
                            <td class="actor-gender">${actor.gender}</td>
                            <td class="actor-dob" data-date="${actor.dob}">${formatDate(actor.dob)}</td>
                            <td class="actor-country">${actor.country}</td>
                            <td>
                                <button class="btn btn-sm btn-primary mr-1" onclick="showUpdate(this)">Update</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteActor(${actor.id})">Delete</button>
                            </td>
                        </tr>
                    `);
                });
            },
            error: (xhr, status, error) => {
                console.error("Error loading actors:", error);
            }
        });
    };

    const loadCountries = () => {
        $.ajax({
            url: '/countries',
            method: 'GET',
            success: (countries) => {
                const select = $('select[name="country"]').empty().append('<option value="">-- Select Country --</option>');
                countries.forEach(country => {
                    select.append(`<option value="${country.name}">${country.name}</option>`);
                });
            },
            error: (xhr, status, error) => {
                console.error("Error loading countries:", error);
            }
        });
    };

    const doAdd = () => {
        const actor = getFormData();
        $.ajax({
            url: '/actors',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(actor),
            success: () => {
                loadActors();
                showViewAll();
            },
            error: (xhr, status, error) => {
                console.error("Error adding actor:", error);
            }
        });
    };

    const doUpdate = () => {
        const actor = getFormData();
        $.ajax({
            url: `/actors/${actor.id}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(actor),
            success: () => {
                loadActors();
                showViewAll();
            },
            error: (xhr, status, error) => {
                console.error("Error updating actor:", error);
            }
        });
    };

    const deleteActor = (id) => {
        if (!confirm("Are you sure you want to delete this actor?")) return;

        $.ajax({
            url: `/actors/${id}`,
            method: 'DELETE',
            success: () => {
                loadActors();
            },
            error: (xhr, status, error) => {
                console.error("Error deleting actor:", error);
            }
        });
    };

    // Initialize
    $(document).ready(() => {
        loadActors();
        loadCountries();
    });
</script>